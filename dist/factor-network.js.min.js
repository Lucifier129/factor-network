/*!
 * factor-network.js v1.0.0
 * (c) 2017-04-08 Jade Gu
 * Released under the MIT License.
 * @license
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.FactorNetwork=n()}(this,function(){"use strict";function t(){return 2*Math.random()-1}function n(){return Math.random()<=.5}function r(t){return Math.max(0,t)}function e(t){return t<=0?0:1}function o(t){return 1/(1+Math.exp(-t/1))}function a(t){return t*(1-t)}function u(t){if(t===1/0)return 1;if(t===-1/0)return-1;var n=Math.exp(2*t);return(n-1)/(n+1)}function i(t){return 1-t*t}function f(n){for(var r=[],e=n[0],o=1;o<n.length;o++){for(var a=[],u=0;u<n[o];u++){for(var i=[],f=0;f<e;f++){var c=t();i.push(c)}a.push(i)}e=a.length,r.push(a)}return r}function c(t,n,r){for(var e=n,o=[n.concat()],a=0;a<t.length;a++){for(var u=t[a],i=[],f=0;f<u.length;f++){for(var c=u[f],v=0,h=0;h<c.length;h++){var p=c[h];v+=e[h]*p}var s=d[r||"SIGMOID"].output(v);i.push(s)}o.push(i),e=i}return o}function v(t,n){for(var r=0;r<t.length;r++)for(var e=t[r],o=0;o<e.length;o++)for(var a=e[o],u=0;u<a.length;u++){var i=a[u];n({weight:i,node:a,layer:e,network:t,path:[r,o,u]})}}function h(t){return JSON.parse(JSON.stringify(t))}function p(t){function n(){return u}function r(t){return i=c(u,t,a.activation)}function e(t){for(var n=[],r=i[i.length-1],e=0;e<t.length;e++){var o=r[e]-t[e];n.push(o)}return s(u,n)}function o(t){var n=e(t);g(u,i,n,a.activation,a.learningRate)}var a=Object.assign({},k,t),u=f(a.network),i=null;return{options:a,getNetwork:n,compute:r,adjust:o}}function s(t,n){for(var r=[n.concat()],e=n,o=t.length-2;o>=0;o--){for(var a=t[o],u=t[o+1],i=[],f=a.length-1;f>=0;f--){for(var c=0,v=u.length-1;v>=0;v--){var h=u[v][f];c+=e[v]*h}i.unshift(c)}r.unshift(i),e=i}return r}function g(t,n,r,e,o){v(t,function(a){var u=a.path,i=t[u[0]][u[1]][u[2]],f=n[u[0]][u[2]],c=n[u[0]+1][u[1]],v=r[u[0]][u[1]],h=-o*v*f*d[e].derivative(c),p=i+h;t[u[0]][u[1]][u[2]]=p})}function l(t){function n(t){for(var n=0;n<t;n++){var r=f(i.network);v.push(r)}i.amount=v.length}function r(t){var r=v.length;r>t?(v.length=t,i.amount=t):r<t&&n(t-r)}function e(){return v}function o(t){for(var n=[],r=0;r<t.length;r++)n.push(v[t[r]]);v=n,i.amount=v.length}function a(t,n){return c(v[t],n,i.activation)}function u(t){t&&o(t);for(var n=[],r=Math.round(i.elitismRate*i.amount),e=0;e<r;e++)n.push(v[e]);for(var a=Math.round(i.randomRate*i.amount),u=0;u<a;u++)n.push(f(i.network));for(var c=0;;){for(var p=0;p<c;p++)for(var s=0;s<i.mixNumber;s++){var g=m(h(v[p]),v[c],i.mutation);if(n.push(g),n.length>=i.amount)return n.length=i.amount,void(v=n)}c++,c===v.length&&(c=0)}}var i=Object.assign({},w,t),v=[];return n(i.amount),{options:i,createNetworks:n,getNetworks:e,sortNetworks:o,updateAmount:r,compute:a,adjust:u}}function m(r,e,o){return v(r,function(a){var u=a.path;if(n()){var i=e[u[0]][u[1]][u[2]];r[u[0]][u[1]][u[2]]=i}Math.random()<=o.rate&&(r[u[0]][u[1]][u[2]]+=o.range*t())}),r}var d={RELU:{output:r,derivative:e},SIGMOID:{output:o,derivative:a},TANH:{output:u,derivative:i}},k={network:[2,2,1],activation:"SIGMOID",learningRate:.1},w={network:[2,2,1],amount:50,elitismRate:.2,randomRate:.2,mixNumber:1,mutation:{rate:.1,range:.5},activation:"SIGMOID"};return{network:Object.freeze({create:f,compute:c,walk:v,copy:h}),createBackPropagation:p,createEvolution:l}});